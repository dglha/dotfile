!function(t){"use strict";var e,n=t.tracker,o=t.zipper,l=t.csnParser,r=t.helper,i=[],s=[{label:"128kbps",type:"128kbps"},{label:"320kbps",type:"320kbps"},{label:"m4a",type:"500kbps"},{label:"Flac",type:"Lossless"}],a=JSON.parse(localStorage.getItem("selectedQuality"))||s[1];function u(){$.get(chrome.extension.getURL("tpl/button.html"),function(t){var e=r.get2RandomColors();$(t).find(".csn-ext-btn").eq(0).css({"background-color":e[0]}).end().end().find(".csn-ext-btn").eq(1).css({"background-color":e[1]}).end().end().appendTo("body"),function(){for(var t="",e=$("#csn-ext-select-quality"),n=0;n<s.length;n++)t+="<option value='"+s[n].type+"'>"+s[n].label+"</option>";e.find("option").remove().end().append($(t)).val(a.type).on("change",function(){var t;t=s.filter(function(t){return t.type===e.val()})[0],a=t,localStorage.setItem("selectedQuality",JSON.stringify(t)),f()})}(),l.isAlbum()||$(".csn-ext-btn").eq(1).css({"background-color":"#ddd",cursor:"not-allowed"})})}function c(t,e){$(document).on("click",t,function(){e.call()})}function p(t,e,n,l){var i=new XMLHttpRequest;i.open("GET",t,!0),i.responseType="blob",i.onload=function(e){if(200==this.status){var l=this.response;o.add(""+r.extractFilename(t),l),n&&n.call()}},i.onerror=function(t){l&&l.call()},i.onprogress=function(t){if(t.lengthComputable){var n=t.loaded/t.total*100;console.info("CSNDOWNLOAD is downloading track at",t.loaded,t.total,n.toFixed(0)+"%")}e&&e.call()},i.send()}function d(t,e){return e=e||75,$("#progress").text(e.toFixed(0)+"%"),t?$("#progress").show():$("#progress").hide()}a=JSON.parse(localStorage.getItem("selectedQuality"))||s[1];function g(t){var e=t.urls.filter(function(t){return t.type===a.type});return 0==e.length&&e.push(t.urls[t.urls.length-1]),t.url=e[0].url,t.size=e[0].size,t.type=e[0].type,t}function f(){if($("#csn-song-size").text(a.label+" · "+g(e).size+"MB"),l.isAlbum()){for(var t=0,n=0;n<i.length;n++)t=parseFloat(t)+parseFloat(g(i[n]).size);$("#csn-album-size").text(i.length+" bài · "+a.label+" · "+t.toFixed(2)+"MB")}}function b(t){window.onbeforeunload=!!t&&function(){return"Đang đao dở. Đừng chuyển trang!"}}function y(t){l.getSongUrl(t,function(t){e=t,l.isAlbum()||u(),$("#csn-ext-song-name").text(t.title).attr("title",t.title),c("#csn-ext-btn-song",function(){n.track("Download",{type:"song",url:r.getCurrentUrl(),title:t.title,quality:a.type}),r.triggerDownloadLink(g(e).url)}),window.setTimeout(function(){f()},250)})}function m(){l.getAlbumUrls(function(t){i=t.songs;var e=r.getCurrentUrl().match(/~(\w*)[\._]/i)[1];y(l.getSongList().songs.filter(function(t){return-1!==t.url.indexOf(e)})[0].url),u(),c("#csn-ext-btn-album",function(){var e,l,s,u,c;n.track("Download",{type:"album",url:r.getCurrentUrl(),title:t.title,quality:a.type}),o.clean(),e=i.map(function(t){return g(t).url}),l=p,s=function(){o.saveZipAs(t.title+".zip")},u=0,(c=function(){d(!0,(u+1)/e.length*100),b(!0),l(e[u],null,function(){u===e.length-1?(d(!1),b(!1),s.call()):(u++,c())})})()}),window.setTimeout(function(){f()},300)})}r.isThisPageValid()&&(l.isAlbum()?m():y(r.getCurrentUrl()))}(window);